<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoBloom 24.1 (Smart Octo)</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .texture-stone { background-color: #d1d5db; background-image: radial-gradient(circle, #9ca3af 20%, transparent 20%), radial-gradient(circle, #9ca3af 20%, transparent 20%); background-size: 10px 10px; background-position: 0 0, 5px 5px; border: 1px solid #9ca3af; }
        .texture-wood { background-color: #78350f; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px, rgba(255,255,255,0.1) 10px); border: 1px solid #451a03; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>

    <!-- ENV CONFIG: Edit these values! -->
    <script>
        window.process = {
            env: {
                // TODO: PASTE YOUR GEMINI API KEY HERE
                API_KEY: 'YOUR_GEMINI_API_KEY_HERE', 
                // TODO: CONFIRM YOUR FIREBASE KEY
                FIREBASE_API_KEY: 'AIzaSyDqEDD2Hds_pX5phI5cZKU3Q-mRtQxTZDg' 
            }
        };
    </script>

    <!-- Import Map for Modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.run/@google/genai",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0?bundle",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.6.0/",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-[100dvh] w-full">
    <div id="root" class="h-full w-full"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";
        import { LogOut, Home, Play, Plus, ArrowRight, Loader2, PlusSquare, Store, CheckSquare, Flower2, ShoppingCart, Send, X } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "firebase/auth";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment, arrayUnion, deleteField } from "firebase/firestore";

        // --- 1. CONFIGURATION & SERVICES ---
        
        const firebaseConfig = {
            apiKey: process.env.FIREBASE_API_KEY,
            authDomain: "duobloom-a9b7b.firebaseapp.com",
            projectId: "duobloom-a9b7b",
            storageBucket: "duobloom-a9b7b.firebasestorage.app",
            messagingSenderId: "118209789780",
            appId: "1:118209789780:web:ce2563e693a76f09a7d2c1",
            measurementId: "G-Z0W0LK6D88"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- GEMINI SERVICE ---
        let chatSession = null;

        const initializeOctoChat = (userName) => {
            if (!process.env.API_KEY || process.env.API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                console.error("Gemini API Key is missing or default!");
                return null;
            }
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            chatSession = ai.chats.create({
                model: 'gemini-2.5-flash',
                config: {
                    systemInstruction: `Du bist Octo, ein freundlicher Oktopus im Spiel DuoBloom.
                    Der Spieler hei√üt ${userName}.
                    Antworte immer kurz (maximal 2-3 S√§tze), lustig und benutze viele Emojis (üêô, üå±, üå∏).
                    Du hilfst beim G√§rtnern und motivierst den Spieler.
                    Sprich Deutsch.`,
                }
            });
            return chatSession;
        };

        const sendMessageToOcto = async (message) => {
            if (!chatSession) return "Octo schl√§ft... (Bitte API Key pr√ºfen!) üêô";
            try {
                const response = await chatSession.sendMessage({ message });
                return response.text;
            } catch (error) {
                console.error("Octo Error:", error);
                return "Blub? Mein Kopf tut weh... (Fehler)";
            }
        };

        // --- 2. CONSTANTS & TYPES ---

        const WATER_COOLDOWN = 6 * 60 * 60 * 1000;
        const ITEMS = {
            carrot_seed: { id: 'carrot_seed', name: 'Karotte', type: 'seed', price: 20, img: 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Food/Carrot.png', icon: 'ü•ï', growsInto: 'carrot', stages: 3, reward: 10 },
            sunflower_seed: { id: 'sunflower_seed', name: 'Sonnenblume', type: 'seed', price: 60, img: 'assets/sunflower.png', icon: 'üåª', growsInto: 'sunflower', stages: 4, reward: 20 },
            stone_floor: { id: 'stone_floor', name: 'Steinweg', type: 'floor', price: 10, css: 'texture-stone', icon: 'ü™®' },
            wood_floor: { id: 'wood_floor', name: 'Holzboden', type: 'floor', price: 25, css: 'texture-wood', icon: 'ü™µ' },
            fence: { id: 'fence', name: 'Zaun', type: 'deco', price: 15, img: 'assets/fence.png', icon: 'üöß' },
            gnome: { id: 'gnome', name: 'Zwerg', type: 'deco', price: 250, img: 'assets/gnome.png', icon: 'üéÖ' },
        };
        const GARDEN_UPGRADES = [
            { id: 0, name: "Start-Garten", price: 0 },
            { id: 1, name: "Hinterhof", price: 200 },
            { id: 2, name: "Waldlichtung", price: 650 },
        ];

        // --- 3. COMPONENTS ---

        const OctoChat = ({ user }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);
            const initialized = useRef(false);

            useEffect(() => {
                if (!initialized.current && user?.displayName) {
                    initializeOctoChat(user.displayName);
                    setMessages([{ role: 'model', text: `Blub Blub! üêô Hallo ${user.displayName.split(' ')[0]}!` }]);
                    initialized.current = true;
                }
            }, [user]);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isOpen]);

            const handleSend = async () => {
                if(!input.trim()) return;
                const txt = input;
                setInput("");
                setMessages(p => [...p, { role: 'user', text: txt }]);
                setIsTyping(true);
                const reply = await sendMessageToOcto(txt);
                setMessages(p => [...p, { role: 'model', text: reply }]);
                setIsTyping(false);
            };

            return (
                <>
                    <button onClick={() => setIsOpen(true)} className="fixed bottom-24 right-4 md:bottom-8 md:right-8 z-40 bg-white p-2 rounded-full shadow-xl border-4 border-purple-200 animate-bounce hover:scale-110">
                        <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Octopus.png" className="w-10 h-10" />
                    </button>
                    {isOpen && (
                        <div className="fixed inset-0 z-[60] flex items-end md:items-center justify-center pointer-events-none">
                            <div className="bg-white w-full md:w-[380px] h-[70vh] md:h-[550px] md:rounded-3xl shadow-2xl flex flex-col pointer-events-auto animate-pop border m-0 md:m-4 overflow-hidden">
                                <div className="bg-purple-600 p-4 text-white flex justify-between items-center shadow-md">
                                    <h3 className="font-bold flex items-center gap-2">üêô Octo AI</h3>
                                    <button onClick={() => setIsOpen(false)}><X size={24} /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`p-3 rounded-2xl text-sm max-w-[85%] ${m.role === 'user' ? 'bg-purple-600 text-white' : 'bg-white border'}`}>{m.text}</div>
                                        </div>
                                    ))}
                                    {isTyping && <div className="text-xs text-gray-400 ml-4 animate-pulse">Octo denkt...</div>}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="p-3 bg-white border-t flex gap-2">
                                    <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key==='Enter' && handleSend()} placeholder="Frag etwas..." className="flex-1 bg-gray-100 rounded-xl px-4 py-3 outline-none" />
                                    <button onClick={handleSend} className="bg-purple-600 text-white p-3 rounded-xl"><Send size={20} /></button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        const GridCell = ({ x, y, cell, handleGridClick, now }) => {
            const floorItem = cell.floor ? ITEMS[cell.floor] : null;
            const objectItem = cell.item ? ITEMS[cell.item] : null;
            let showTimer = false, timeLeftStr = "";

            if (objectItem && objectItem.type === 'seed' && !cell.grown) {
                const lastWatered = cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0;
                const diff = now - lastWatered;
                if (diff < WATER_COOLDOWN) {
                    showTimer = true;
                    const ms = WATER_COOLDOWN - diff;
                    timeLeftStr = Math.floor(ms / 3600000) + "h " + Math.floor((ms % 3600000) / 60000) + "m";
                }
            }

            return (
                <div onClick={() => handleGridClick(x, y)} className={`w-14 h-14 md:w-20 md:h-20 relative cursor-pointer ${floorItem ? floorItem.css : 'bg-white/10 border border-white/20'}`}>
                    {objectItem && (
                        <div className="absolute inset-0 flex items-center justify-center z-10 hover:scale-110 transition-transform">
                            {cell.grown || objectItem.type === 'deco' ? (
                                objectItem.img ? <img src={objectItem.img} className="w-10 h-10 md:w-16 md:h-16 object-contain drop-shadow-md" /> : <span className="text-4xl">{objectItem.icon}</span>
                            ) : (
                                <div className="flex flex-col items-center relative">
                                    {objectItem.img ? <img src={objectItem.img} className="w-8 h-8 md:w-12 md:h-12 object-contain opacity-70" /> : <span className="text-2xl">{objectItem.icon}</span>}
                                    {!showTimer && <div className="absolute -top-4 bg-blue-500 text-white text-[8px] px-1 rounded-full animate-bounce">Gie√üen!</div>}
                                    <div className="w-8 h-1 bg-black/20 rounded-full mt-1 overflow-hidden">
                                        <div className="h-full bg-blue-500" style={{width: `${((cell.stage || 0)/(objectItem.stages || 1))*100}%`}} />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {!objectItem && floorItem && <div className="absolute inset-0 hover:bg-white/20 transition-colors"></div>}
                </div>
            );
        };

        const GameApp = ({ user, roomCode, isSpectator, onBackToMenu }) => {
            const [roomData, setRoomData] = useState(null);
            const [tab, setTab] = useState('garden');
            const [activeGardenIdx, setActiveGardenIdx] = useState(0);
            const [selectedItem, setSelectedItem] = useState(null);
            const [now, setNow] = useState(Date.now());

            useEffect(() => {
                if(!roomCode) return;
                const unsub = onSnapshot(doc(db, 'rooms', roomCode), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if(!data.gardens) data.gardens = { 0: {} };
                        if(!data.inventory) data.inventory = {};
                        if(!data.unlockedGardens) data.unlockedGardens = [0];
                        setRoomData(data);
                    }
                });
                return () => unsub();
            }, [roomCode]);

            useEffect(() => { const t = setInterval(() => setNow(Date.now()), 1000); return () => clearInterval(t); }, []);

            const handleGridClick = async (x, y) => {
                if (isSpectator || !roomData) return;
                const key = `${x},${y}`;
                const cell = (roomData.gardens[activeGardenIdx] || {})[key] || {};
                const roomRef = doc(db, 'rooms', roomCode);
                const path = `gardens.${activeGardenIdx}.${key}`;

                if (selectedItem) {
                    const itemDef = ITEMS[selectedItem];
                    if (roomData.inventory[selectedItem] > 0) {
                        if (itemDef.type === 'floor' && !cell.item) await updateDoc(roomRef, { [`${path}.floor`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) });
                        else if (itemDef.type === 'seed' && !cell.floor && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`${path}.stage`]: 0, [`${path}.plantedAt`]: new Date().toISOString(), [`inventory.${selectedItem}`]: increment(-1) });
                        else if (itemDef.type === 'deco' && !cell.item) await updateDoc(roomRef, { [`${path}.item`]: selectedItem, [`inventory.${selectedItem}`]: increment(-1) });
                    }
                    return;
                }

                if (cell.item) {
                    const itemDef = ITEMS[cell.item];
                    if (cell.grown && itemDef.type === 'seed') await updateDoc(roomRef, { [`${path}.item`]: deleteField(), [`${path}.stage`]: deleteField(), [`${path}.grown`]: deleteField(), gems: increment(itemDef.reward || 0) });
                    else if (itemDef.type === 'seed' && (now - (cell.lastWatered ? new Date(cell.lastWatered).getTime() : 0) > WATER_COOLDOWN)) {
                        const newStage = (cell.stage || 0) + 1;
                        await updateDoc(roomRef, { [`${path}.stage`]: newStage, [`${path}.grown`]: newStage >= itemDef.stages, [`${path}.lastWatered`]: new Date().toISOString() });
                    }
                }
            };

            const buy = async (id, isGarden) => {
                if (isSpectator || !roomData) return;
                if(isGarden) {
                     const g = GARDEN_UPGRADES.find(x => x.id === parseInt(id));
                     if(g && roomData.gems >= g.price) await updateDoc(doc(db, 'rooms', roomCode), { gems: increment(-g.price), unlockedGardens: arrayUnion(parseInt(id)), [`gardens.${id}`]: {} });
                } else {
                     const item = ITEMS[id];
                     if(roomData.coins >= item.price) await updateDoc(doc(db, 'rooms', roomCode), { coins: increment(-item.price), [`inventory.${id}`]: increment(1) });
                }
            };

            if (!roomData) return <div className="h-full flex items-center justify-center animate-pulse">Lade Garten...</div>;
            const currentGrid = roomData.gardens[activeGardenIdx] || {};

            return (
                <div className="flex h-full bg-slate-100 overflow-hidden md:max-w-7xl md:mx-auto md:my-8 md:rounded-3xl md:shadow-2xl md:border border-slate-200">
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t z-40 flex justify-around p-2 pb-safe md:relative md:w-64 md:flex-col md:justify-start md:border-t-0 md:border-r md:p-6 md:gap-4">
                        <div className="hidden md:block mb-8"><h1 className="text-2xl font-bold text-green-600 flex items-center gap-2"><Flower2/> DuoBloom</h1></div>
                        <button onClick={() => setTab('garden')} className={`p-3 rounded-xl flex gap-3 ${tab==='garden'?'bg-green-50 text-green-600 font-bold':'text-gray-400'}`}><Flower2/> <span className="hidden md:inline">Garten</span></button>
                        <button onClick={() => setTab('shop')} className={`p-3 rounded-xl flex gap-3 ${tab==='shop'?'bg-orange-50 text-orange-600 font-bold':'text-gray-400'}`}><Store/> <span className="hidden md:inline">Shop</span></button>
                    </nav>
                    <main className="flex-1 overflow-y-auto bg-[#eefcf3] relative pb-28 md:pb-0">
                         <header className="sticky top-0 backdrop-blur-md p-4 shadow-sm z-30 flex justify-between items-center px-6 bg-white/90">
                            <div className="flex items-center gap-4">
                                <button onClick={onBackToMenu} className="bg-white border p-2 rounded-xl"><Home size={20}/></button>
                                <span className="font-bold text-gray-700">{roomData.roomName}</span>
                            </div>
                            <div className="flex gap-4 font-bold"><span className="text-yellow-600">üí∞ {roomData.coins}</span><span className="text-purple-600">üíé {roomData.gems}</span></div>
                        </header>
                        
                        {tab === 'garden' && (
                            <div className="p-4 flex flex-col items-center">
                                <div className="flex gap-2 mb-4 overflow-x-auto w-full justify-center">
                                    {GARDEN_UPGRADES.map(g => (roomData.unlockedGardens||[]).includes(g.id) && <button key={g.id} onClick={() => setActiveGardenIdx(g.id)} className={`px-4 py-1 rounded-full text-sm font-bold border ${activeGardenIdx === g.id ? 'bg-green-500 text-white' : 'bg-white text-green-700'}`}>{g.name}</button>)}
                                </div>
                                <div className="p-4 rounded-xl shadow-2xl relative inline-block bg-[#5c4033]">
                                    <div className="grid grid-cols-5 gap-0 border-2 border-black/10">
                                        {Array.from({ length: 25 }).map((_, i) => <GridCell key={i} x={i%5} y={Math.floor(i/5)} cell={currentGrid[`${i%5},${Math.floor(i/5)}`] || {}} handleGridClick={handleGridClick} now={now} />)}
                                    </div>
                                </div>
                                <div className="mt-8 w-full max-w-2xl bg-white p-4 rounded-2xl shadow-lg border flex gap-3 overflow-x-auto">
                                    {Object.entries(roomData.inventory).map(([id, c]) => c > 0 && (
                                        <button key={id} onClick={() => setSelectedItem(selectedItem===id?null:id)} className={`flex-shrink-0 flex flex-col items-center p-3 rounded-xl border-2 min-w-[80px] ${selectedItem===id?'border-blue-500 bg-blue-50':''}`}>
                                            {ITEMS[id].img ? <img src={ITEMS[id].img} className="w-8 h-8"/> : <span className="text-2xl">{ITEMS[id].icon}</span>}
                                            <span className="text-xs font-bold text-gray-600">{c}x</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        {tab === 'shop' && (
                             <div className="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                                {Object.values(ITEMS).map(item => (
                                    <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border flex flex-col items-center">
                                        <div className="text-4xl mb-3">{item.img ? <img src={item.img} className="w-12 h-12"/> : item.icon}</div>
                                        <button onClick={() => buy(item.id, false)} disabled={roomData.coins < item.price} className={`w-full py-2 rounded-xl text-sm font-bold ${roomData.coins >= item.price ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-400'}`}>{item.price} üí∞</button>
                                    </div>
                                ))}
                             </div>
                        )}
                    </main>
                    <OctoChat user={user} />
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login');
            const [currentRoom, setCurrentRoom] = useState(localStorage.getItem('lastRoom'));
            const [joinCode, setJoinCode] = useState("");

            useEffect(() => onAuthStateChanged(auth, u => { setUser(u); setView(u ? 'menu' : 'login'); }), []);

            const handleCreate = async () => {
                const code = Math.random().toString(36).substring(2, 7).toUpperCase();
                await setDoc(doc(db, 'rooms', code), { 
                    roomName: "Mein Garten", owner: user.uid, createdAt: new Date().toISOString(), 
                    inventory: { carrot_seed: 2 }, coins: 50, gems: 0, gardens: {0:{}}, unlockedGardens: [0] 
                });
                enterRoom(code);
            };

            const enterRoom = (code) => { localStorage.setItem('lastRoom', code); setCurrentRoom(code); setView('game'); };

            if (view === 'login') return (
                <div className="h-full flex flex-col items-center justify-center bg-green-100">
                    <button onClick={() => signInWithPopup(auth, googleProvider)} className="bg-white p-4 rounded-xl font-bold shadow-xl">Mit Google anmelden</button>
                </div>
            );

            if (view === 'menu') return (
                <div className="h-full bg-slate-100 flex items-center justify-center p-4">
                     <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md space-y-4">
                        <h2 className="text-xl font-bold text-center">Hallo, {user.displayName}!</h2>
                        {currentRoom && <button onClick={() => enterRoom(currentRoom)} className="w-full bg-green-100 text-green-800 p-4 rounded-xl font-bold flex justify-between"><span>Weiter: {currentRoom}</span> <Play size={20}/></button>}
                        <button onClick={handleCreate} className="w-full bg-blue-500 text-white p-4 rounded-xl font-bold flex justify-center gap-2"><PlusSquare/> Neuer Garten</button>
                        <div className="flex gap-2">
                            <input value={joinCode} onChange={e => setJoinCode(e.target.value.toUpperCase())} placeholder="CODE" className="flex-1 bg-gray-100 rounded-xl px-4 font-bold" />
                            <button onClick={() => joinCode && enterRoom(joinCode)} className="bg-gray-800 text-white px-6 rounded-xl"><ArrowRight/></button>
                        </div>
                        <button onClick={() => signOut(auth)} className="text-gray-400 text-sm w-full text-center">Logout</button>
                     </div>
                </div>
            );

            return <GameApp user={user} roomCode={currentRoom} onBackToMenu={() => setView('menu')} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Failed', err));
        }
    </script>
</body>
</html>